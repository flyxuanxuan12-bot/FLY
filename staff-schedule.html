<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>员工工作安排系统</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
        }
        body {
            padding: 20px;
            background-color: #f5f7fa;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
        }
        /* 按钮样式 */
        .btn-group {
            text-align: center;
            margin-bottom: 20px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: #1677ff;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            margin: 0 5px;
            transition: background 0.2s;
        }
        .btn:hover {
            background: #0d66d0;
        }
        /* 按月分隔日历核心样式 */
        .calendar {
            display: none;
            gap: 30px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }
        .calendar.active {
            display: flex;
        }
        .calendar-month {
            width: calc(33.333% - 20px);
            min-width: 300px;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }
        .month-title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #1677ff;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        .month-week-header {
            display: grid;
            /* 8列：周一到周日 + 周汇总 */
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
            margin-bottom: 8px;
        }
        .month-week-header span {
            text-align: center;
            font-weight: bold;
            color: #666;
            padding: 6px 0;
            font-size: 13px;
        }
        .month-days {
            display: grid;
            /* 8列：日期列 + 周汇总按钮列 */
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
        }
        .day-cell {
            padding: 10px 0;
            text-align: center;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.2s;
            border: 1px solid #eee;
            cursor: pointer;
            background: #fff;
            min-height: 42px; /* 保证高度一致 */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .day-cell.empty {
            border: none;
            background: transparent;
            cursor: default;
        }
        .day-cell:hover:not(.empty) {
            background: #e6f7ff;
            border-color: #91d5ff;
        }
        .day-cell.today {
            background: #1677ff;
            color: #fff;
            border-color: #1677ff;
        }
        /* 周汇总按钮样式 */
        .week-view-btn-cell {
            text-align: center;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .week-view-btn {
            width: 100%;
            height: 100%;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            background: #52c41a;
            color: #fff;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            line-height: 1.2;
        }
        .week-view-btn:hover {
            background: #389e0d;
        }
        /* 工作安排表样式 */
        .schedule-table {
            display: none;
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .schedule-table.active {
            display: table;
        }
        .schedule-table th, .schedule-table td {
            border: 1px solid #ccc;
            padding: 12px;
            text-align: left;
            vertical-align: top;
        }
        .schedule-table th {
            background: #f2f2f2;
            font-weight: bold;
            color: #333;
        }
        .schedule-table td.employee {
            background: #f9f9f9;
            font-weight: 500;
            cursor: default;
        }
        .schedule-table td.input-cell {
            min-height: 60px;
            outline: none;
            cursor: text;
        }
        .schedule-table td.input-cell:focus {
            background: #fffbe6;
            border-color: #ffc53d;
        }
        /* 周汇总表格样式 */
        .week-summary-table {
            display: none;
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .week-summary-table.active {
            display: table;
        }
        .week-summary-table th, .week-summary-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
            vertical-align: top;
            font-size: 13px;
        }
        .week-summary-table th {
            background: #f2f2f2;
            font-weight: bold;
            color: #333;
            text-align: center;
        }
        .week-summary-table td.employee {
            background: #f9f9f9;
            font-weight: 500;
            text-align: center;
        }
        .date-title {
            text-align: center;
            font-size: 18px;
            color: #1677ff;
            margin-bottom: 15px;
            font-weight: 500;
        }
        /* 响应式适配 */
        @media (max-width: 1024px) {
            .calendar-month {width: calc(50% - 15px);}
        }
        @media (max-width: 640px) {
            .calendar-month {width: 100%;}
            .week-view-btn {font-size: 11px;}
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>员工工作安排系统</h1>
        <div class="btn-group">
            <button class="btn" id="backCalendar">返回日历</button>
            <button class="btn" id="exportToday">导出当日Excel</button>
            <button class="btn" id="exportAll">导出全部Excel</button>
            <button class="btn" id="exportWeek">导出本周Excel</button>
        </div>
        
        <div class="calendar active" id="calendar"></div>
        
        <div id="scheduleContainer">
            <div class="date-title" id="dateTitle"></div>
            <table class="schedule-table" id="scheduleTable">
                <thead>
                    <tr>
                        <th width="20%">员工姓名</th>
                        <th width="80%">当日工作安排（点击可编辑，支持多行）</th>
                    </tr>
                </thead>
                <tbody id="scheduleTbody"></tbody>
            </table>
        </div>
        
        <div id="weekSummaryContainer">
            <div class="date-title" id="weekSummaryTitle"></div>
            <table class="week-summary-table" id="weekSummaryTable">
                <thead id="weekSummaryThead"></thead>
                <tbody id="weekSummaryTbody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // ===================== 配置区域 =====================
        const firebaseConfig = {
            apiKey: "AIzaSyA-q_tMZ9hxccIcQn163cnH1lm15ppIJok",
            authDomain: "staff-scheduling-system-8bde6.firebaseapp.com",
            databaseURL: "https://staff-scheduling-system-8bde6-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "staff-scheduling-system-8bde6",
            storageBucket: "staff-scheduling-system-8bde6.firebasestorage.app",
            messagingSenderId: "611008571565",
            appId: "1:611008571565:web:d383451c1d503cbdb6be24"
        };
        const EMPLOYEE_LIST = ["田科培", "李洪涛", "李娟", "周媛", "熊正江", "祁亚飞", "郝成慧", "张艺", "朱兴", "丁靖", "张庭瑞", "张洲", "黄金", "王露", "李雪琦", "李雨亭", "陈梦媛", "赵芯"];
        // ===================================================

        const YEAR = new Date().getFullYear();
        const WEEK_HEADERS = ["周一", "周二", "周三", "周四", "周五", "周六", "周日", "周汇总"];
        let currentSelectDate = "";
        let currentWeekRange = { start: "", end: "" };
        let db;
        let employeeCellMap = {};

        firebase.initializeApp(firebaseConfig);
        db = firebase.database();

        document.addEventListener('DOMContentLoaded', function() {
            initCalendarByMonth(YEAR);
            bindBaseEvent();
            document.getElementById('exportWeek').style.display = 'none';
        });

        function bindBaseEvent() {
            document.getElementById('backCalendar').addEventListener('click', () => {
                document.getElementById('calendar').classList.add('active');
                document.getElementById('scheduleTable').classList.remove('active');
                document.getElementById('weekSummaryTable').classList.remove('active');
                document.getElementById('exportWeek').style.display = 'none';
                if (currentSelectDate) db.ref(`schedules/${currentSelectDate}`).off();
                employeeCellMap = {};
                currentWeekRange = { start: "", end: "" };
            });
        }

        // 核心修复：按月生成日历，确保日期和按钮对齐
        function initCalendarByMonth(year) {
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';
            
            for (let month = 0; month < 12; month++) {
                const monthContainer = document.createElement('div');
                monthContainer.className = 'calendar-month';

                const monthTitle = document.createElement('div');
                monthTitle.className = 'month-title';
                monthTitle.innerHTML = `${year}年${month + 1}月`;
                monthContainer.appendChild(monthTitle);

                const weekHeader = document.createElement('div');
                weekHeader.className = 'month-week-header';
                WEEK_HEADERS.forEach(week => {
                    const span = document.createElement('span');
                    span.innerHTML = week;
                    weekHeader.appendChild(span);
                });
                monthContainer.appendChild(weekHeader);

                const daysContainer = document.createElement('div');
                daysContainer.className = 'month-days';

                // 1. 计算月初空白格（严格对应周一到周日）
                const firstDayOfMonth = new Date(year, month, 1);
                let firstDayWeek = firstDayOfMonth.getDay(); // 0=周日
                firstDayWeek = firstDayWeek === 0 ? 6 : firstDayWeek - 1; // 转换为 0=周一 ... 6=周日

                // 2. 渲染空白格（千万不要在这里添加第8列的占位符，这是导致错位的根源）
                for (let i = 0; i < firstDayWeek; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'day-cell empty';
                    daysContainer.appendChild(emptyCell);
                }

                const totalDays = new Date(year, month + 1, 0).getDate();
                let currentColumn = firstDayWeek; // 0-6 (周一到周日)
                let weekStartDate = null; 

                // 3. 循环渲染日期
                for (let day = 1; day <= totalDays; day++) {
                    const currentDate = new Date(year, month, day);
                    const dateStr = formatDate(currentDate);
                    
                    // 记录每周的开始日期（如果是周一）
                    if (currentColumn === 0) {
                        weekStartDate = new Date(currentDate);
                    }

                    // 创建日期格
                    const dayCell = document.createElement('div');
                    dayCell.className = 'day-cell';
                    dayCell.innerHTML = day;
                    if (isCurrentDay(currentDate)) dayCell.classList.add('today');
                    dayCell.addEventListener('click', () => {
                        currentSelectDate = dateStr;
                        renderScheduleTable(dateStr);
                    });
                    daysContainer.appendChild(dayCell);

                    // 4. 处理周日（currentColumn = 6）：添加周汇总按钮
                    if (currentColumn === 6) {
                        // 修复：如果月初是周四，第一周结束时 weekStartDate 为 null，需反推
                        if (!weekStartDate) {
                            weekStartDate = new Date(currentDate);
                            weekStartDate.setDate(currentDate.getDate() - 6);
                        }
                        
                        addWeekButton(daysContainer, weekStartDate, currentDate); // 添加按钮
                        
                        currentColumn = 0; // 重置为周一
                    } else {
                        currentColumn++; // 移至下一天
                    }
                }

                // 5. 处理月末剩余空白并补齐按钮
                // 如果 month 结束时不是周日（currentColumn != 0，因为循环结束时如果刚过周日会被重置为0）
                // 注意：上面的循环在周日时会将 currentColumn 重置为 0。所以如果 currentColumn > 0，说明最后一周没过完。
                if (currentColumn !== 0) {
                    // 补全剩余天数的空白格（直到周日，即 index 6）
                    for (let i = currentColumn; i <= 6; i++) {
                        const emptyCell = document.createElement('div');
                        emptyCell.className = 'day-cell empty';
                        daysContainer.appendChild(emptyCell);
                    }
                    
                    // 必须补上最后一周的“周汇总”按钮，否则布局会缺角
                    // 计算最后一周的起止时间
                    const lastDay = new Date(year, month, totalDays);
                    if (!weekStartDate) { // 防御性编程
                         weekStartDate = new Date(lastDay);
                         // 回退到本周一 (currentColumn此时已指向下个空白位，需修正逻辑)
                         // 简单做法：直接用最后一天推算周一
                         // lastDay 对应 currentColumn-1
                         let dayIndex = (lastDay.getDay() === 0 ? 6 : lastDay.getDay() - 1);
                         weekStartDate.setDate(lastDay.getDate() - dayIndex);
                    }
                    // 结束时间就是本周日（跨入下月）
                    let weekEndDate = new Date(weekStartDate);
                    weekEndDate.setDate(weekEndDate.getDate() + 6);

                    addWeekButton(daysContainer, weekStartDate, weekEndDate);
                }

                monthContainer.appendChild(daysContainer);
                calendar.appendChild(monthContainer);
            }
        }

        // 辅助函数：添加周汇总按钮
        function addWeekButton(container, startDate, endDate) {
            const startStr = formatDate(startDate);
            const endStr = formatDate(endDate);
            
            const btnCell = document.createElement('div');
            btnCell.className = 'week-view-btn-cell';
            
            const viewBtn = document.createElement('button');
            viewBtn.className = 'week-view-btn';
            viewBtn.innerHTML = '查看<br>周汇总'; // 换行以适应窄列
            viewBtn.addEventListener('click', () => {
                currentWeekRange = { start: startStr, end: endStr };
                renderWeekSummary(startStr, endStr);
            });
            
            btnCell.appendChild(viewBtn);
            container.appendChild(btnCell);
        }

        function renderScheduleTable(dateStr) {
            const calendar = document.getElementById('calendar');
            const scheduleTable = document.getElementById('scheduleTable');
            const weekSummaryTable = document.getElementById('weekSummaryTable');
            const dateTitle = document.getElementById('dateTitle');
            const scheduleTbody = document.getElementById('scheduleTbody');

            calendar.classList.remove('active');
            weekSummaryTable.classList.remove('active');
            scheduleTable.classList.add('active');
            dateTitle.innerHTML = `${dateStr} 员工工作安排表`;
            document.getElementById('exportWeek').style.display = 'none';
            
            scheduleTbody.innerHTML = '';
            employeeCellMap = {};

            EMPLOYEE_LIST.forEach(employee => {
                const tr = document.createElement('tr');
                const tdEmployee = document.createElement('td');
                tdEmployee.className = 'employee';
                tdEmployee.innerHTML = employee;
                const tdInput = document.createElement('td');
                tdInput.className = 'input-cell';
                tdInput.contentEditable = true;
                employeeCellMap[employee] = tdInput;

                let saveTimer = null;
                tdInput.addEventListener('input', () => {
                    clearTimeout(saveTimer);
                    saveTimer = setTimeout(() => {
                        saveScheduleToFirebase(dateStr, employee, tdInput.innerHTML);
                    }, 300);
                });

                tr.appendChild(tdEmployee);
                tr.appendChild(tdInput);
                scheduleTbody.appendChild(tr);
            });

            const scheduleRef = db.ref(`schedules/${dateStr}`);
            scheduleRef.on('value', (snapshot) => {
                const dayData = snapshot.val() || {};
                EMPLOYEE_LIST.forEach(employee => {
                    const cell = employeeCellMap[employee];
                    if (cell !== document.activeElement) {
                        cell.innerHTML = dayData[employee] || '';
                    }
                });
            });

            document.getElementById('exportToday').onclick = () => exportTodayExcel(dateStr);
            document.getElementById('exportAll').onclick = () => exportAllExcel();
        }

        function renderWeekSummary(weekStartStr, weekEndStr) {
            const calendar = document.getElementById('calendar');
            const scheduleTable = document.getElementById('scheduleTable');
            const weekSummaryTable = document.getElementById('weekSummaryTable');
            const weekSummaryTitle = document.getElementById('weekSummaryTitle');
            const weekSummaryThead = document.getElementById('weekSummaryThead');
            const weekSummaryTbody = document.getElementById('weekSummaryTbody');

            calendar.classList.remove('active');
            scheduleTable.classList.remove('active');
            weekSummaryTable.classList.add('active');
            weekSummaryTitle.innerHTML = `${weekStartStr} 至 ${weekEndStr} 员工工作安排周汇总`;
            document.getElementById('exportWeek').style.display = 'inline-block';

            const weekDateList = [];
            let currentDate = new Date(weekStartStr);
            while (currentDate <= new Date(weekEndStr)) {
                weekDateList.push(formatDate(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }

            weekSummaryThead.innerHTML = '';
            const theadTr = document.createElement('tr');
            theadTr.innerHTML = '<th>员工姓名</th>';
            weekDateList.forEach(dateStr => {
                theadTr.innerHTML += `<th>${dateStr}</th>`;
            });
            weekSummaryThead.appendChild(theadTr);

            weekSummaryTbody.innerHTML = '';
            db.ref(`schedules`).once('value', (snapshot) => {
                const allScheduleData = snapshot.val() || {};
                EMPLOYEE_LIST.forEach(employee => {
                    const tr = document.createElement('tr');
                    const tdEmployee = document.createElement('td');
                    tdEmployee.className = 'employee';
                    tdEmployee.innerHTML = employee;
                    tr.appendChild(tdEmployee);

                    weekDateList.forEach(dateStr => {
                        const dayData = allScheduleData[dateStr] || {};
                        const td = document.createElement('td');
                        td.innerHTML = dayData[employee] || '';
                        tr.appendChild(td);
                    });
                    weekSummaryTbody.appendChild(tr);
                });
            });

            document.getElementById('exportToday').onclick = () => exportTodayExcel(currentSelectDate);
            document.getElementById('exportAll').onclick = () => exportAllExcel();
            document.getElementById('exportWeek').onclick = () => exportWeekExcel(weekStartStr, weekEndStr, weekDateList);
        }

        function saveScheduleToFirebase(dateStr, employee, content) {
            db.ref(`schedules/${dateStr}/${employee}`).set(content);
        }

        function exportTodayExcel(dateStr) {
            if (!dateStr) return alert("请先选择日期");
            db.ref(`schedules/${dateStr}`).once('value', (snapshot) => {
                const dayData = snapshot.val() || {};
                const excelData = [
                    ['员工姓名', '当日工作安排'],
                    ...EMPLOYEE_LIST.map(emp => [emp, dayData[emp] || ''])
                ];
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                XLSX.utils.book_append_sheet(wb, ws, dateStr);
                XLSX.writeFile(wb, `${dateStr}员工工作安排表.xlsx`);
            });
        }

        function exportWeekExcel(weekStartStr, weekEndStr, weekDateList) {
            db.ref(`schedules`).once('value', (snapshot) => {
                const allScheduleData = snapshot.val() || {};
                const excelData = [
                    ['员工姓名', ...weekDateList],
                    ...EMPLOYEE_LIST.map(employee => {
                        const row = [employee];
                        weekDateList.forEach(dateStr => {
                            const dayData = allScheduleData[dateStr] || {};
                            row.push(dayData[employee] || '');
                        });
                        return row;
                    })
                ];
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                XLSX.utils.book_append_sheet(wb, ws, `${weekStartStr}至${weekEndStr}`);
                XLSX.writeFile(wb, `${weekStartStr}至${weekEndStr}员工工作安排周汇总.xlsx`);
            });
        }

        function exportAllExcel() {
            db.ref(`schedules`).once('value', (snapshot) => {
                const allData = snapshot.val() || {};
                const wb = XLSX.utils.book_new();
                const sheetNames = Object.keys(allData).sort();
                if (sheetNames.length === 0) return alert("暂无数据可导出");
                
                sheetNames.forEach(dateStr => {
                    const dayData = allData[dateStr];
                    const excelData = [
                        ['员工姓名', '当日工作安排'],
                        ...EMPLOYEE_LIST.map(emp => [emp, dayData[emp] || ''])
                    ];
                    const ws = XLSX.utils.aoa_to_sheet(excelData);
                    XLSX.utils.book_append_sheet(wb, ws, dateStr);
                });
                XLSX.writeFile(wb, `${YEAR}年员工工作安排汇总表.xlsx`);
            });
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function isCurrentDay(date) {
            const today = new Date();
            return date.getFullYear() === today.getFullYear() &&
                   date.getMonth() === today.getMonth() &&
                   date.getDate() === today.getDate();
        }
    </script>
</body>
</html>
