<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>员工工作安排系统</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        /* 原有样式不变，此处省略 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
        }
        body {
            padding: 20px;
            background-color: #f5f7fa;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
        }
        .btn-group {
            text-align: center;
            margin-bottom: 20px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: #1677ff;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
        }
        .btn:hover {
            background: #0d66d0;
        }
        .calendar {
            display: none;
            gap: 30px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }
        .calendar.active {
            display: flex;
        }
        .calendar-month {
            width: calc(33.333% - 20px);
            min-width: 300px;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }
        .month-title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #1677ff;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        .month-week-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 8px;
        }
        .month-week-header span {
            text-align: center;
            font-weight: bold;
            color: #666;
            padding: 6px 0;
            font-size: 13px;
        }
        .month-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        .day-cell {
            padding: 10px 0;
            text-align: center;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.2s;
            border: 1px solid #eee;
            cursor: pointer;
            background: #fff;
        }
        .day-cell.empty {
            border: none;
            background: transparent;
            cursor: default;
        }
        .day-cell:hover {
            background: #e6f7ff;
            border-color: #91d5ff;
        }
        .day-cell.today {
            background: #1677ff;
            color: #fff;
            border-color: #1677ff;
        }
        .schedule-table {
            display: none;
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .schedule-table.active {
            display: table;
        }
        .schedule-table th, .schedule-table td {
            border: 1px solid #ccc;
            padding: 12px;
            text-align: left;
            vertical-align: top;
        }
        .schedule-table th {
            background: #f2f2f2;
            font-weight: bold;
            color: #333;
        }
        .schedule-table td.employee {
            background: #f9f9f9;
            font-weight: 500;
            cursor: default;
        }
        .schedule-table td.input-cell {
            min-height: 60px;
            outline: none;
            cursor: text;
        }
        .schedule-table td.input-cell:focus {
            background: #fffbe6;
            border-color: #ffc53d;
        }
        .date-title {
            text-align: center;
            font-size: 18px;
            color: #1677ff;
            margin-bottom: 15px;
            font-weight: 500;
        }
        @media (max-width: 1024px) {
            .calendar-month {width: calc(50% - 15px);}
        }
        @media (max-width: 640px) {
            .calendar-month {width: 100%;}
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>员工工作安排系统</h1>
        <div class="btn-group">
            <button class="btn" id="backCalendar">返回日历</button>
            <button class="btn" id="exportToday">导出当日Excel</button>
            <button class="btn" id="exportAll">导出全部Excel</button>
        </div>
        <div class="calendar active" id="calendar"></div>
        <div id="scheduleContainer">
            <div class="date-title" id="dateTitle"></div>
            <table class="schedule-table" id="scheduleTable">
                <thead>
                    <tr>
                        <th width="20%">员工姓名</th>
                        <th width="80%">当日工作安排（点击可编辑，支持多行）</th>
                    </tr>
                </thead>
                <tbody id="scheduleTbody"></tbody>
            </table>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA-q_tMZ9hxccIcQn163cnH1lm15ppIJok",
            authDomain: "staff-scheduling-system-8bde6.firebaseapp.com",
            databaseURL: "https://staff-scheduling-system-8bde6-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "staff-scheduling-system-8bde6",
            storageBucket: "staff-scheduling-system-8bde6.firebasestorage.app",
            messagingSenderId: "611008571565",
            appId: "1:611008571565:web:d383451c1d503cbdb6be24"
        };
        const EMPLOYEE_LIST = ["田科培", "李洪涛", "李娟", "周媛", "熊正江", "祁亚飞", "郝成慧", "张艺", "朱兴", "丁靖", "张庭瑞", "张洲", "黄金", "王露", "李雪琦", "李雨亭", "陈梦媛", "赵芯"];

        // 全局变量优化：增加当前监听的引用，便于精准取消
        const YEAR = new Date().getFullYear();
        const WEEK_HEADERS = ["周一", "周二", "周三", "周四", "周五", "周六", "周日"];
        let currentSelectDate = "";
        let db;
        let currentScheduleRef = null; // 新增：保存当前日期的监听引用

        // 节流函数：解决input高频触发写入问题（500ms内只执行一次）
        function throttle(fn, delay = 500) {
            let timer = null;
            return function(...args) {
                if (!timer) {
                    timer = setTimeout(() => {
                        fn.apply(this, args);
                        timer = null;
                    }, delay);
                }
            };
        }

        firebase.initializeApp(firebaseConfig);
        db = firebase.database();

        document.addEventListener('DOMContentLoaded', function() {
            initCalendarByMonth(YEAR);
            bindBaseEvent();
        });

        function bindBaseEvent() {
            document.getElementById('backCalendar').addEventListener('click', () => {
                document.getElementById('calendar').classList.add('active');
                document.getElementById('scheduleTable').classList.remove('active');
                // 优化：精准取消当前日期的监听
                if (currentScheduleRef) {
                    currentScheduleRef.off();
                    currentScheduleRef = null;
                }
                currentSelectDate = "";
            });
        }

        function initCalendarByMonth(year) {
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';
            for (let month = 0; month < 12; month++) {
                const monthContainer = document.createElement('div');
                monthContainer.className = 'calendar-month';

                const monthTitle = document.createElement('div');
                monthTitle.className = 'month-title';
                monthTitle.innerHTML = `${year}年${month + 1}月`;
                monthContainer.appendChild(monthTitle);

                const weekHeader = document.createElement('div');
                weekHeader.className = 'month-week-header';
                WEEK_HEADERS.forEach(week => {
                    const span = document.createElement('span');
                    span.innerHTML = week;
                    weekHeader.appendChild(span);
                });
                monthContainer.appendChild(weekHeader);

                const daysContainer = document.createElement('div');
                daysContainer.className = 'month-days';

                const firstDayOfMonth = new Date(year, month, 1);
                let firstDayWeek = firstDayOfMonth.getDay();
                firstDayWeek = firstDayWeek === 0 ? 6 : firstDayWeek - 1;
                for (let i = 0; i < firstDayWeek; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'day-cell empty';
                    daysContainer.appendChild(emptyCell);
                }

                const totalDays = new Date(year, month + 1, 0).getDate();
                for (let day = 1; day <= totalDays; day++) {
                    const currentDate = new Date(year, month, day);
                    const dateStr = formatDate(currentDate);
                    const isToday = isCurrentDay(currentDate);

                    const dayCell = document.createElement('div');
                    dayCell.className = 'day-cell';
                    dayCell.innerHTML = day;
                    if (isToday) dayCell.classList.add('today');
                    dayCell.addEventListener('click', () => {
                        currentSelectDate = dateStr;
                        renderScheduleTable(dateStr);
                    });

                    daysContainer.appendChild(dayCell);
                }

                monthContainer.appendChild(daysContainer);
                calendar.appendChild(monthContainer);
            }
        }

        function renderScheduleTable(dateStr) {
            const calendar = document.getElementById('calendar');
            const scheduleTable = document.getElementById('scheduleTable');
            const dateTitle = document.getElementById('dateTitle');
            const scheduleTbody = document.getElementById('scheduleTbody');

            // 关键修复1：切换日期时，先取消上一个日期的监听
            if (currentScheduleRef) {
                currentScheduleRef.off();
                currentScheduleRef = null;
            }

            calendar.classList.remove('active');
            scheduleTable.classList.add('active');
            dateTitle.innerHTML = `${dateStr} 员工工作安排表`;
            scheduleTbody.innerHTML = '';

            // 关键修复2：保存当前监听引用，便于后续取消
            currentScheduleRef = db.ref(`schedules/${dateStr}`);
            currentScheduleRef.on('value', (snapshot) => {
                const dayData = snapshot.val() || {};
                scheduleTbody.innerHTML = '';
                EMPLOYEE_LIST.forEach(employee => {
                    const tr = document.createElement('tr');
                    const tdEmployee = document.createElement('td');
                    tdEmployee.className = 'employee';
                    tdEmployee.innerHTML = employee;

                    const tdInput = document.createElement('td');
                    tdInput.className = 'input-cell';
                    tdInput.contentEditable = true;
                    tdInput.innerHTML = dayData[employee] || '';

                    // 关键修复3：给input事件添加节流，避免高频写入
                    const throttledSave = throttle((content) => {
                        saveScheduleToFirebase(dateStr, employee, content);
                    }, 500);

                    tdInput.addEventListener('input', (e) => {
                        throttledSave(e.target.innerHTML);
                    });

                    tr.appendChild(tdEmployee);
                    tr.appendChild(tdInput);
                    scheduleTbody.appendChild(tr);
                });
            }, (error) => {
                // 新增：监听错误处理，便于排查问题
                console.error('监听Firebase数据失败：', error);
                alert('数据同步失败，请刷新页面重试！');
            });

            document.getElementById('exportToday').onclick = () => exportTodayExcel(dateStr);
            document.getElementById('exportAll').onclick = () => exportAllExcel();
        }

        // 关键修复4：添加写入错误处理，确保数据写入可靠
        function saveScheduleToFirebase(dateStr, employee, content) {
            db.ref(`schedules/${dateStr}/${employee}`)
                .set(content)
                .then(() => {
                    console.log(`成功保存【${dateStr}】-${employee}的工作安排`);
                })
                .catch((error) => {
                    console.error(`保存失败【${dateStr}】-${employee}：`, error);
                    alert(`保存失败：${error.message}，请重新输入！`);
                });
        }

        function exportTodayExcel(dateStr) {
            db.ref(`schedules/${dateStr}`).once('value', (snapshot) => {
                const dayData = snapshot.val() || {};
                const excelData = [
                    ['员工姓名', '当日工作安排'],
                    ...EMPLOYEE_LIST.map(emp => [emp, dayData[emp] || ''])
                ];
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                XLSX.utils.book_append_sheet(wb, ws, dateStr);
                XLSX.writeFile(wb, `${dateStr}员工工作安排表.xlsx`);
            });
        }

        function exportAllExcel() {
            db.ref(`schedules`).once('value', (snapshot) => {
                const allData = snapshot.val() || {};
                const wb = XLSX.utils.book_new();
                Object.keys(allData).forEach(dateStr => {
                    const dayData = allData[dateStr];
                    const excelData = [
                        ['员工姓名', '当日工作安排'],
                        ...EMPLOYEE_LIST.map(emp => [emp, dayData[emp] || ''])
                    ];
                    const ws = XLSX.utils.aoa_to_sheet(excelData);
                    XLSX.utils.book_append_sheet(wb, ws, dateStr);
                });
                XLSX.writeFile(wb, `${YEAR}年员工工作安排汇总表.xlsx`);
            });
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function isCurrentDay(date) {
            const today = new Date();
            return date.getFullYear() === today.getFullYear() &&
                   date.getMonth() === today.getMonth() &&
                   date.getDate() === today.getDate();
        }
    </script>
</body>
</html>
